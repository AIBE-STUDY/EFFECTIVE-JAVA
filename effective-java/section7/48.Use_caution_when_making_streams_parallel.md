# 48. ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ëŠ” ì£¼ì˜í•´ì„œ ì ìš©í•˜ë¼

ìë°”ëŠ” ë™ì‹œì„± í”„ë¡œê·¸ë˜ë°ì„ ê¾¸ì¤€íˆ ë°œì „ì‹œì¼œì™”ë‹¤

* ìë°” 5: java.util.concurrent ë¼ì´ë¸ŒëŸ¬ë¦¬, ì‹¤í–‰ì(Executor) í”„ë ˆì„ì›Œí¬ ë„ì…
* ìë°” 7: í¬í¬-ì¡°ì¸(Fork-Join) íŒ¨í‚¤ì§€ ì¶”ê°€
* ìë°” 8: ìŠ¤íŠ¸ë¦¼ APIì™€ parallel() ë©”ì„œë“œ ë„ì…

ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ëŠ” ë‹¤ì¤‘ ì½”ì–´ í”„ë¡œì„¸ì„œë¥¼ í™œìš©í•˜ì—¬ ì‘ì—…ì„ ì—¬ëŸ¬ ìŠ¤ë ˆë“œì— ë¶„ì‚°ì‹œí‚¤ëŠ” ë°©ë²•ì´ë‹¤

ë‹¨ í•œ ì¤„ì˜ ì½”ë“œë¡œ ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸ì„ ë³‘ë ¬ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤

```java
// ìˆœì°¨ ìŠ¤íŠ¸ë¦¼
list.stream().map(x -> x * 2).forEach(System.out::println);

// ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ - parallel() ë©”ì„œë“œ í•˜ë‚˜ë§Œ ì¶”ê°€
list.stream().parallel().map(x -> x * 2).forEach(System.out::println);
```

\


## ë³‘ë ¬í™”ì— ì í•©í•œ ì¡°ê±´

1. ì¶©ë¶„íˆ í° ë°ì´í„°ì…‹: ë°ì´í„°ê°€ ë§ì„ìˆ˜ë¡ ë³‘ë ¬í™”ì˜ ì´ì ì´ ì»¤ì§„ë‹¤
2.  íš¨ìœ¨ì ìœ¼ë¡œ ë¶„í•  ê°€ëŠ¥í•œ ë°ì´í„° êµ¬ì¡°:

    * ArrayList, HashMap, HashSet, ConcurrentHashMap
    * ë°°ì—´(Array)
    * int ë²”ìœ„, long ë²”ìœ„

    ì´ ìë£Œêµ¬ì¡°ë“¤ì€ ë‘ ê°€ì§€ íŠ¹ì„±ì„ ê°–ëŠ”ë‹¤

    * ë°ì´í„°ë¥¼ ì‰½ê²Œ ë‚˜ëˆŒ ìˆ˜ ìˆìŒ (Spliteratorê°€ ë‹´ë‹¹)
    * ì°¸ì¡° ì§€ì—­ì„±(locality of reference)ì´ ë›°ì–´ë‚¨
3. ê³„ì‚° ë¹„ìš©ì´ í° ì—°ì‚°: ìš”ì†Œë‹¹ ì²˜ë¦¬ ì‹œê°„ì´ ë§ì´ ê±¸ë¦´ìˆ˜ë¡ ë³‘ë ¬í™” íš¨ê³¼ê°€ ì»¤ì§‘ë‹ˆë‹¤.

\


## ë³‘ë ¬í™”ê°€ íš¨ê³¼ì ì¸ ì½”ë“œ ì˜ˆì‹œ

ì†Œìˆ˜ ê³„ì‚° ì˜ˆì œ - ë³‘ë ¬í™”ì— ì í•©í•œ ê²½ìš°:

```java
// ìˆœì°¨ì  ì†Œìˆ˜ ê³„ì‚°
static long pi(long n) {
    return LongStream.rangeClosed(2, n)
            .mapToObj(BigInteger::valueOf)
            .filter(i -> i.isProbablePrime(50))
            .count();
}

// ë³‘ë ¬ ì†Œìˆ˜ ê³„ì‚°
static long piParallel(long n) {
    return LongStream.rangeClosed(2, n)
            .parallel()
            .mapToObj(BigInteger::valueOf)
            .filter(i -> i.isProbablePrime(50))
            .count();
}
```

ì´ ì˜ˆì œì—ì„œëŠ” ë³‘ë ¬ ì²˜ë¦¬ê°€ ìˆœì°¨ ì²˜ë¦¬ë³´ë‹¤ ì•½ 3ë°° ë¹ ë¥´ë‹¤

\


## ë³‘ë ¬í™”ë¥¼ í”¼í•´ì•¼ í•˜ëŠ” ê²½ìš°

1.  ë¶„í• í•˜ê¸° ì–´ë ¤ìš´ ë°ì´í„° ì†ŒìŠ¤:

    ```java
    // ì˜ëª»ëœ ë³‘ë ¬í™” ì˜ˆì‹œ (ì‘ë‹µ ë¶ˆê°€ ìƒíƒœ ë°œìƒ ê°€ëŠ¥)
    Stream.iterate(BigInteger.ONE, n -> n.add(BigInteger.ONE))
        .parallel()
        .map(p -> p.isProbablePrime(50))
        .limit(20)
        .forEach(System.out::println);
    ```

    Stream.iterateì™€ ê°™ì€ ì†ŒìŠ¤ëŠ” ì´ì „ ìš”ì†Œì— ì˜ì¡´ì ì´ì–´ì„œ ë¶„í• ì´ ì–´ë µë‹¤
2. ìˆœì„œì— ì˜ì¡´ì ì¸ ì—°ì‚°: limit(), findFirst() ë“±ì€ ë³‘ë ¬í™”ì™€ ìƒì¶©ëœë‹¤
3. ë°ì´í„°ê°€ ì ì€ ê²½ìš°: ë³‘ë ¬í™” ì˜¤ë²„í—¤ë“œê°€ ì´ë“ë³´ë‹¤ í´ ìˆ˜ ìˆë‹¤

\


## ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ì˜ ì„±ëŠ¥ ë¹„êµ

| ì‘ì—… ìœ í˜•                  | ìˆœì°¨ ì²˜ë¦¬ | ë³‘ë ¬ ì²˜ë¦¬ | íš¨ìœ¨ì ì¸ ë°©ì‹ |
| ---------------------- | ----- | ----- | ------- |
| ì†Œê·œëª¨ ë°ì´í„° (100ê°œ)         | 5ms   | 15ms  | ìˆœì°¨ ì²˜ë¦¬   |
| ëŒ€ê·œëª¨ ë°ì´í„° (100ë§Œê°œ)        | 120ms | 40ms  | ë³‘ë ¬ ì²˜ë¦¬   |
| ë³µì¡í•œ ì—°ì‚° (ì†Œìˆ˜ ê³„ì‚°)         | 200ms | 60ms  | ë³‘ë ¬ ì²˜ë¦¬   |
| ë‹¨ìˆœ ì—°ì‚° (ë§ì…ˆ)             | 3ms   | 10ms  | ìˆœì°¨ ì²˜ë¦¬   |
| Stream.iterate + limit | 8ms   | ë¬´í•œëŒ€   | ìˆœì°¨ ì²˜ë¦¬   |

![Image](https://github.com/user-attachments/assets/a50829dc-26df-423c-b206-e7f4b7cfd261)\


## ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì´ ì‘ë™í•˜ëŠ” ë°©ì‹

ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì€ ë‚´ë¶€ì ìœ¼ë¡œ í¬í¬-ì¡°ì¸(ForkJoinPool) í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•œë‹¤

![Image](https://github.com/user-attachments/assets/65d7e161-b496-42e7-b065-b321ffb67fdc)![Image](https://github.com/user-attachments/assets/ef66b178-8f89-4d65-9999-a8d0ab71845a)

ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì€ ê¸°ë³¸ì ìœ¼ë¡œ ê³µí†µ ForkJoinPoolì˜ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ì˜ëª»ëœ ë³‘ë ¬í™”ëŠ” ë‹¤ë¥¸ ë¶€ë¶„ì—ë„ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤

\


## ë³‘ë ¬í™” ì‹œ ì£¼ì˜í•´ì•¼ í•  í•¨ìˆ˜ ìš”êµ¬ì‚¬í•­

ìŠ¤íŠ¸ë¦¼ ëª…ì„¸ëŠ” í•¨ìˆ˜ ê°ì²´ì— ëŒ€í•œ ì¤‘ìš”í•œ ê·œì•½ì„ ì •ì˜í•œë‹¤

1. **ê²°í•©ë²•ì¹™(associative)ì„ ë§Œì¡±í•  ê²ƒ** : (a op b) op c = a op (b op c)
2. **ê°„ì„­ë°›ì§€ ì•Šì„ ê²ƒ(non-interfering)** : íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ë°ì´í„° ì†ŒìŠ¤ ë³€ê²½ ê¸ˆì§€
3. **ìƒíƒœë¥¼ ê°–ì§€ ì•Šì„ ê²ƒ(stateless)** : ì´ì „ ìš”ì†Œì˜ ê²°ê³¼ì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨

ì´ëŸ¬í•œ ìš”êµ¬ì‚¬í•­ì„ ì§€í‚¤ì§€ ì•Šìœ¼ë©´ ë³‘ë ¬ ì‹¤í–‰ ì‹œ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤

\


## ì‹¤ìš©ì ì¸ ë³‘ë ¬í™” ì˜ˆì œ ì½”ë“œ

ë‹¤ì–‘í•œ ìë£Œêµ¬ì¡°ì™€ ì‘ì—…ì— ë”°ë¥¸ ë³‘ë ¬í™” íš¨ê³¼ ë¹„êµ:

```java
import java.time.Duration;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.IntStream;

public class ParallelStreamDemo {
    public static void main(String[] args) {
        // ëŒ€ê·œëª¨ ë°ì´í„° ì¤€ë¹„ (1ì²œë§Œ ê°œ)
        List<Integer> bigList = IntStream.rangeClosed(1, 10_000_000)
                               .boxed()
                               .collect(ArrayList::new, ArrayList::add, ArrayList::addAll);

        // ê°„ë‹¨í•œ ì—°ì‚° (í•©ê³„)
        System.out.println("ê°„ë‹¨í•œ ì—°ì‚° (í•©ê³„):");
        Instant start = Instant.now();
        long sum = bigList.stream().mapToLong(i -> i).sum();
        System.out.println("ìˆœì°¨ ì²˜ë¦¬: " + Duration.between(start, Instant.now()).toMillis() + "ms");

        start = Instant.now();
        long sumParallel = bigList.parallelStream().mapToLong(i -> i).sum();
        System.out.println("ë³‘ë ¬ ì²˜ë¦¬: " + Duration.between(start, Instant.now()).toMillis() + "ms");

        // ë³µì¡í•œ ì—°ì‚° (ì†Œìˆ˜ íŒë³„)
        System.out.println("\në³µì¡í•œ ì—°ì‚° (ì†Œìˆ˜ íŒë³„):");
        start = Instant.now();
        long primeCount = bigList.stream()
                               .limit(100_000)
                               .filter(ParallelStreamDemo::isPrime)
                               .count();
        System.out.println("ìˆœì°¨ ì²˜ë¦¬: " + Duration.between(start, Instant.now()).toMillis() + "ms");

        start = Instant.now();
        long primeCountParallel = bigList.parallelStream()
                                     .limit(100_000)
                                     .filter(ParallelStreamDemo::isPrime)
                                     .count();
        System.out.println("ë³‘ë ¬ ì²˜ë¦¬: " + Duration.between(start, Instant.now()).toMillis() + "ms");
    }

    // ì†Œìˆ˜ íŒë³„ ë©”ì„œë“œ (ê³„ì‚° ë¹„ìš©ì´ í° ì—°ì‚°)
    static boolean isPrime(int n) {
        if (n <= 1) return false;
        if (n <= 3) return true;
        if (n % 2 == 0 || n % 3 == 0) return false;

        for (int i = 5; i * i <= n; i += 6) {
            if (n % i == 0 || n % (i + 2) == 0) return false;
        }
        return true;
    }
}
```

\


## í•µì‹¬ ì •ë¦¬

ë³‘ë ¬í™”ëŠ” ëª¨ë“  ìƒí™©ì—ì„œ ì„±ëŠ¥ í–¥ìƒì„ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤

ì ìš© ì „í›„ ë°˜ë“œì‹œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì•¼ í•œë‹¤

ë³‘ë ¬í™”ì— ì í•©í•œ ìë£Œêµ¬ì¡°ì™€ ì—°ì‚°ì„ ì„ íƒí•´ì•¼ í•œë‹¤

ê³µí†µ `ForkJoinPool` ì— ì˜í–¥ì„ ì£¼ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì ìš©í•´ì•¼ í•œë‹¤

ë‹¨ìˆœíˆ `.parallel()` ì„ í˜¸ì¶œí•˜ëŠ” ê²ƒë³´ë‹¤ ì ì ˆí•œ ìƒí™©ì—ì„œì˜ ì ìš©ì´ ì¤‘ìš”í•˜ë‹¤

\| "ê³„ì‚°ì˜ ì •í™•ì„±ê³¼ ì„±ëŠ¥ í–¥ìƒì´ í™•ì‹¤í•  ë•Œë§Œ ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ë¥¼ ì ìš©í•˜ë¼."

\


***

## ğŸ§© ì–´ë ¤ì› ë˜ ì 

ë³‘ë ¬í™”ê°€ í•­ìƒ ì„±ëŠ¥ í–¥ìƒìœ¼ë¡œ ì´ì–´ì§€ì§€ ì•ŠëŠ” ì´ìœ ë¥¼ ì´í•´í•˜ëŠ” ë° ì‹œê°„ì´ í•„ìš”í–ˆë‹¤

ìë£Œêµ¬ì¡°ë³„ ë³‘ë ¬í™” íš¨ìœ¨ì„± ì°¨ì´ì˜ ì›ì¸(ë¶„í•  ìš©ì´ì„±ê³¼ ì°¸ì¡° ì§€ì—­ì„±)ì„ ì´í•´í•˜ëŠ” ê³¼ì •ì´ ë³µì¡í–ˆë‹¤

ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì—ì„œ í•¨ìˆ˜ ìš”êµ¬ì‚¬í•­(ê²°í•©ë²•ì¹™, ë¹„ê°„ì„­ì„±, ë¬´ìƒíƒœ)ì˜ ì¤‘ìš”ì„±ì„ ì¸ì‹í•˜ëŠ” ê²ƒì´ ì–´ë ¤ì› ë‹¤

\


## ğŸ’­ ëŠë‚€ ì 

ë‹¨ìˆœíˆ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒë³´ë‹¤ ê·¸ ì›ë¦¬ì™€ ì ìš© ì¡°ê±´ì„ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤

ìë£Œêµ¬ì¡°ì™€ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•œ ì´í•´ê°€ íš¨ìœ¨ì ì¸ ë³‘ë ¬ ì²˜ë¦¬ì— í•„ìˆ˜ì ì´ë‹¤

ê¸°ìˆ ì˜ ì¥ë‹¨ì ì„ ì •í™•íˆ íŒŒì•…í•˜ê³  ì ì ˆíˆ í™œìš©í•˜ëŠ” ê²ƒì´ ì¢‹ì€ ê°œë°œìì˜ ìì„¸ë¼ê³  ìƒê°í•˜ê²Œ ë˜ì—ˆë‹¤
